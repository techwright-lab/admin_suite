<%# locals: (email:, selected: false, show_company: true) %>

<% is_opportunity = email.recruiter_outreach? %>
<% link_path = is_opportunity && email.opportunity.present? ? opportunity_path(email.opportunity) : inbox_path(email) %>
<% link_frame = is_opportunity ? "_top" : "email_detail" %>

<%= link_to link_path,
    class: "block px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer #{selected ? 'bg-primary-50 dark:bg-primary-900/20 border-l-2 border-primary-500' : ''} #{is_opportunity ? 'border-l-2 border-indigo-400 dark:border-indigo-500' : ''}",
    data: { 
      turbo_frame: link_frame,
      action: is_opportunity ? nil : "click->inbox-mobile#openEmail"
    } do %>
  <div class="flex items-start gap-3">
    <!-- Type indicator / Avatar -->
    <div class="flex-shrink-0 mt-0.5">
      <div
        class="
          w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium
          <%= case email.email_type
          when 'recruiter_outreach' then 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400'
          when 'offer' then 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
          when 'rejection' then 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
          when 'interview_invite', 'scheduling' then 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
          when 'application_confirmation' then 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400'
          else 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400'
          end %>
        "
      >
        <%= email.sender_display[0].upcase %>
      </div>
    </div>

    <div class="flex-1 min-w-0">
      <!-- Sender & Date -->
      <div class="flex items-center justify-between gap-2">
        <span class="text-sm font-medium text-gray-900 dark:text-white truncate">
          <%= email.sender_display %>
        </span>

        <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0">
          <%= email.email_date ? time_ago_in_words(email.email_date, include_seconds: false) : "" %>
        </span>
      </div>

      <!-- Subject -->
      <p class="text-sm text-gray-700 dark:text-gray-300 truncate mt-0.5">
        <%= email.subject || "(No subject)" %>
      </p>

      <!-- Snippet -->
      <p class="text-xs text-gray-500 dark:text-gray-400 truncate mt-0.5">
        <%= email.snippet&.truncate(80) %>
      </p>

      <!-- Meta row: Company, Thread count, Type badge -->
      <div class="flex items-center gap-2 mt-1.5">
        <% if show_company && email.company.present? %>
          <span
            class="
              inline-flex items-center px-1.5 py-0.5 rounded text-xs
              font-medium bg-gray-100 dark:bg-gray-700 text-gray-600
              dark:text-gray-400
            "
          >
            <%= email.company.name %>
          </span>
        <% end %>

        <% if email.has_thread? %>
          <span
            class="
              inline-flex items-center gap-1 text-xs text-gray-500
              dark:text-gray-400
            "
          >
            <svg
              class="w-3 h-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
              />
            </svg>

            <%= email.thread_count %>
          </span>
        <% end %>

        <% if email.email_type.present? && !%w[other].include?(email.email_type) %>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium <%= email.type_badge_classes %>">
            <% if email.recruiter_outreach? %>
              <svg
                class="w-3 h-3 mr-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                />
              </svg>
              Opportunity
            <% else %>
              <%= email.email_type.split("_").first.capitalize %>
            <% end %>
          </span>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
