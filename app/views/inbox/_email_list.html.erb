<%# locals: (grouped_emails:, unmatched_emails:, selected_email_id: nil, pagy_unmatched: nil) %>

<div class="divide-y divide-gray-200 dark:divide-gray-700">
  <!-- Needs Review Section -->
  <% if unmatched_emails.any? %>
    <div class="bg-amber-50 dark:bg-amber-900/10">
      <div class="px-4 py-2 bg-amber-100 dark:bg-amber-900/30 border-b border-amber-200 dark:border-amber-800">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-amber-600 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <span class="text-xs font-medium text-amber-800 dark:text-amber-300">
            <%= pagy_unmatched ? "#{pagy_unmatched.count} emails need review" : "Needs Review" %>
          </span>
        </div>
      </div>
      <% unmatched_emails.each do |email| %>
        <%= render "inbox/email_row", email: email, selected: selected_email_id == email.id, show_company: true %>
      <% end %>
      <% if pagy_unmatched && pagy_unmatched.pages > 1 %>
        <div class="px-4 py-3 bg-amber-50 dark:bg-amber-900/20 border-t border-amber-200 dark:border-amber-800">
          <div class="flex items-center justify-between text-xs">
            <span class="text-amber-700 dark:text-amber-400">
              Page <%= pagy_unmatched.page %> of <%= pagy_unmatched.pages %>
            </span>
            <div class="flex gap-2">
              <% if pagy_unmatched.prev %>
                <%= link_to "← Previous", inbox_index_path(unmatched_page: pagy_unmatched.prev),
                  class: "px-2 py-1 text-amber-600 dark:text-amber-400 hover:bg-amber-100 dark:hover:bg-amber-900/30 rounded" %>
              <% end %>
              <% if pagy_unmatched.next %>
                <%= link_to "Next →", inbox_index_path(unmatched_page: pagy_unmatched.next),
                  class: "px-2 py-1 text-amber-600 dark:text-amber-400 hover:bg-amber-100 dark:hover:bg-amber-900/30 rounded" %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Matched Emails by Application -->
  <% if grouped_emails.any? %>
    <% grouped_emails.each do |application, emails| %>
      <% next unless application %>
      <div class="email-group">
        <!-- Application Header -->
        <div class="sticky top-0 z-10 px-4 py-2 bg-gray-100/95 dark:bg-gray-800/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 shadow-sm">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 bg-white dark:bg-gray-700 rounded flex items-center justify-center text-xs font-medium text-gray-600 dark:text-gray-400 shadow-sm">
              <%= application.company.name[0].upcase %>
            </div>
            <div class="flex-1 min-w-0">
              <span class="text-xs font-medium text-gray-900 dark:text-white truncate block">
                <%= application.company.name %>
              </span>
              <span class="text-xs text-gray-500 dark:text-gray-400">
                <%= application.job_role.title %> · <%= emails.count %> emails
              </span>
            </div>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium
              <%= case application.pipeline_stage.to_sym
                  when :applied then 'bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300'
                  when :screening then 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
                  when :interviewing then 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400'
                  when :offer then 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
                  else 'bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300'
                  end %>">
              <%= application.pipeline_stage_display %>
            </span>
          </div>
        </div>

        <!-- Emails in this application -->
        <% emails.first(5).each do |email| %>
          <%= render "inbox/email_row", email: email, selected: selected_email_id == email.id, show_company: false %>
        <% end %>
        <% if emails.count > 5 %>
          <div class="px-4 py-2 text-center bg-gray-50 dark:bg-gray-800/50">
            <span class="text-xs text-gray-500 dark:text-gray-400">
              +<%= emails.count - 5 %> more emails
            </span>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>

  <!-- Empty State -->
  <% if grouped_emails.empty? && unmatched_emails.empty? %>
    <div class="p-8 text-center">
      <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
      <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">No emails found</p>
      <% unless Current.user.google_connected? %>
        <%= link_to settings_path(tab: "integrations"),
            class: "mt-3 inline-flex items-center text-sm text-primary-600 dark:text-primary-400 hover:underline" do %>
          Connect Gmail to sync emails
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
