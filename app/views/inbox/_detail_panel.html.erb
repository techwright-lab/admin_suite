<%# locals: (email:, thread_emails:, application: nil) %>

<div class="flex flex-col h-full overflow-hidden bg-white dark:bg-gray-800 lg:bg-gray-50 lg:dark:bg-gray-900">
  <!-- Header with application context -->
  <div class="flex-shrink-0 relative overflow-hidden bg-gradient-to-r from-slate-50 to-gray-100 dark:from-gray-800 dark:to-gray-850 border-b border-gray-200/80 dark:border-gray-700/80">
    <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-primary-100/30 to-transparent dark:from-primary-900/10 rounded-full blur-3xl"></div>
    
    <div class="relative px-5 py-4">
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1 min-w-0">
          <h2 class="text-lg font-bold text-gray-900 dark:text-white leading-snug">
            <%= email.clean_subject %>
          </h2>
          
          <div class="mt-2 flex items-center gap-2 flex-wrap">
            <% if application.present? %>
              <%= link_to interview_application_path(application), 
                  class: "inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm hover:shadow transition-all duration-200 hover:border-primary-300 dark:hover:border-primary-600" do %>
                <div class="w-6 h-6 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-600 dark:to-gray-700 rounded-md flex items-center justify-center text-xs font-bold text-gray-600 dark:text-gray-300">
                  <%= application.company.name[0].upcase %>
                </div>
                <div class="text-sm">
                  <span class="font-medium text-gray-900 dark:text-white"><%= application.company.name %></span>
                  <span class="text-gray-400 dark:text-gray-500 mx-1">Â·</span>
                  <span class="text-gray-500 dark:text-gray-400"><%= application.job_role.title %></span>
                </div>
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              <% end %>
            <% elsif email.company.present? %>
              <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-700 text-sm text-gray-600 dark:text-gray-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                <%= email.company.name %>
              </span>
            <% end %>
            
            <% if thread_emails.size > 1 %>
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-primary-50 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <%= thread_emails.size %> messages
              </span>
            <% end %>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-2">
          <% if email.recruiter_outreach? && email.opportunity.present? %>
            <%= link_to opportunity_path(email.opportunity),
                class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white rounded-xl shadow-lg shadow-indigo-500/25 transition-all duration-200 hover:shadow-xl hover:shadow-indigo-500/30 hover:-translate-y-0.5",
                title: "View opportunity" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
              </svg>
              View Opportunity
            <% end %>
          <% end %>
          
          <% unless email.matched? %>
            <%= button_to ignore_inbox_path(email),
                method: :patch,
                class: "p-2.5 text-gray-400 hover:text-rose-600 dark:hover:text-rose-400 rounded-xl hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-all duration-200",
                title: "Mark as not interview-related",
                data: { turbo_confirm: "Mark this email as not interview-related?" } do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
              </svg>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Conversation Thread -->
  <div class="flex-1 overflow-y-auto">
    <%= render "inbox/conversation", thread_emails: thread_emails, current_email: email %>
  </div>

  <!-- Match to Application (if not matched) -->
  <% unless email.matched? %>
    <div class="flex-shrink-0 px-4 py-3 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-t border-amber-200/60 dark:border-amber-800/40">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-amber-100 dark:bg-amber-800/40 flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-amber-600 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="flex-1">
          <p class="text-sm font-medium text-amber-800 dark:text-amber-200">Not matched to an application</p>
          <p class="text-xs text-amber-600 dark:text-amber-400 mt-0.5">Match this email to track your interview progress</p>
        </div>
      </div>
      
      <%= form_with url: match_application_inbox_path(email), method: :patch, class: "mt-3 flex items-center gap-2" do |f| %>
        <%= f.select :application_id,
            options_from_collection_for_select(Current.user.interview_applications.includes(:company, :job_role).where(status: :active).order("companies.name"), :id, ->(a) { "#{a.company.name} - #{a.job_role.title}" }),
            { include_blank: "Select application..." },
            class: "flex-1 text-sm rounded-xl border-amber-200 dark:border-amber-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500 py-2.5 shadow-sm" %>
        <%= f.submit "Match", class: "px-5 py-2.5 text-sm font-semibold bg-amber-600 hover:bg-amber-700 text-white rounded-xl shadow-lg shadow-amber-500/25 transition-all duration-200 hover:shadow-xl cursor-pointer" %>
      <% end %>
    </div>
  <% end %>
</div>
