<% content_for :title, "Inbox" %>
<% content_for :full_bleed, true %>

<!-- Desktop: Split-pane layout / Mobile: Full-width list -->
<div class="h-full flex flex-col" data-controller="inbox-mobile">
  <!-- Mobile Header -->
  <div class="lg:hidden px-4 py-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
    <h1 class="text-lg font-semibold text-gray-900 dark:text-white">Inbox</h1>
    <p class="text-sm text-gray-500 dark:text-gray-400">
      <%= Current.user.synced_emails.count %> emails synced
    </p>
  </div>

  <div class="flex-1 flex overflow-hidden">
    <!-- Left Panel: Email List -->
    <div class="w-full lg:w-2/5 xl:w-1/3 flex flex-col border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"
         data-inbox-mobile-target="list">
      <!-- Desktop Header -->
      <div class="hidden lg:block p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-lg font-semibold text-gray-900 dark:text-white">Inbox</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              Interview-related emails
            </p>
          </div>
          <% if Current.user.google_connected? %>
            <%= button_to trigger_sync_settings_path,
                method: :post,
                class: "p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",
                title: "Sync emails",
                data: { disable_with: "..." } do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Relevance Tabs -->
      <%= turbo_frame_tag "relevance_tabs" do %>
        <div class="flex border-b border-gray-200 dark:border-gray-700">
          <% relevance_tabs = [
            { key: "relevant", label: "Relevant", count: @relevance_counts[:relevant] },
            { key: "interviews", label: "Interviews", count: @relevance_counts[:interviews] },
            { key: "opportunities", label: "Opportunities", count: @relevance_counts[:opportunities] },
            { key: "all", label: "All", count: @relevance_counts[:all] }
          ] %>
          <% relevance_tabs.each do |tab| %>
            <%= link_to inbox_index_path(relevance: tab[:key], q: params[:q], status: params[:status]),
                class: "flex-1 px-3 py-2 text-xs font-medium text-center border-b-2 transition-colors #{@current_relevance == tab[:key] ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300'}",
                data: { turbo_action: "replace" } do %>
              <%= tab[:label] %>
              <% if tab[:count] > 0 %>
                <span class="ml-1 px-1.5 py-0.5 text-xs rounded-full <%= @current_relevance == tab[:key] ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' %>">
                  <%= tab[:count] %>
                </span>
              <% end %>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <!-- Search & Filters -->
      <div class="p-3 border-b border-gray-200 dark:border-gray-700">
        <%= form_with url: inbox_index_path, method: :get, class: "space-y-2", data: { turbo_action: "replace" } do |f| %>
          <%= f.hidden_field :relevance, value: @current_relevance %>
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <%= f.text_field :q,
                value: params[:q],
                class: "w-full pl-9 pr-3 py-2 text-sm rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent",
                placeholder: "Search emails..." %>
          </div>
          <div class="flex gap-2">
            <%= f.select :status,
                [["All", ""], ["Needs Review", "unmatched"], ["Matched", "matched"]],
                { selected: params[:status] },
                class: "flex-1 px-2 py-1.5 text-xs rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-primary-500" %>
            <%= f.submit "Filter", class: "px-3 py-1.5 text-xs font-medium bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors cursor-pointer" %>
            <% if params[:q].present? || params[:status].present? || (params[:relevance].present? && params[:relevance] != "relevant") %>
              <%= link_to "Ã—", inbox_index_path, class: "px-2 py-1.5 text-gray-500 hover:text-gray-700 dark:text-gray-400", data: { turbo_action: "replace" } %>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Email List (scrollable) -->
      <%= turbo_frame_tag "email_list", class: "flex-1 overflow-y-auto" do %>
        <%= render "inbox/email_list", 
            grouped_emails: @grouped_emails, 
            unmatched_emails: @unmatched_emails,
            pagy_unmatched: @pagy_unmatched,
            selected_email_id: @selected_email&.id %>
      <% end %>

      <!-- Stats Footer -->
      <%= turbo_frame_tag "email_stats", class: "hidden lg:flex items-center justify-between px-4 py-2 border-t border-gray-200 dark:border-gray-700 text-xs text-gray-500 dark:text-gray-400" do %>
        <span><%= @unmatched_emails.count %> needs review</span>
        <span><%= Current.user.synced_emails.matched.count %> matched</span>
      <% end %>
    </div>

    <!-- Right Panel: Email Detail -->
    <div class="hidden lg:flex flex-1 flex-col bg-gray-50 dark:bg-gray-900"
         data-inbox-mobile-target="detail">
      <%= turbo_frame_tag "email_detail", class: "flex-1 flex flex-col overflow-hidden" do %>
        <%= render "inbox/empty_state" %>
      <% end %>
    </div>

    <!-- Mobile: Full-screen modal for email detail -->
    <div class="lg:hidden fixed inset-0 z-50 bg-white dark:bg-gray-800 transform translate-x-full transition-transform duration-300 ease-in-out"
         data-inbox-mobile-target="modal"
         data-action="keydown.esc->inbox-mobile#close">
      <div class="h-full flex flex-col">
        <!-- Mobile modal header -->
        <div class="flex items-center px-4 py-3 border-b border-gray-200 dark:border-gray-700">
          <button type="button" 
                  class="p-2 -ml-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                  data-action="click->inbox-mobile#close">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <span class="ml-2 text-sm font-medium text-gray-900 dark:text-white">Back to Inbox</span>
        </div>
        <!-- Mobile modal content -->
        <div class="flex-1 overflow-y-auto">
          <%= turbo_frame_tag "email_detail_mobile", class: "h-full" do %>
            <div class="p-4 text-center text-gray-500 dark:text-gray-400">
              <p>Select an email to view</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
