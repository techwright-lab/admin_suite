<% content_for :title, "Inbox" %>
<% content_for :full_bleed, true %>

<!-- Desktop: Split-pane layout / Mobile: Full-width list -->
<div class="h-full flex flex-col" data-controller="inbox-mobile">
  <!-- Mobile Header -->
  <div class="lg:hidden relative overflow-hidden bg-gradient-to-r from-gray-900 via-slate-800 to-gray-900 px-4 py-4">
    <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg%20width%3D%2230%22%20height%3D%2230%22%20viewBox%3D%220%200%2030%2030%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M1.22676%200C1.91374%200%202.45351%200.539773%202.45351%201.22676C2.45351%201.91374%201.91374%202.45351%201.22676%202.45351C0.539773%202.45351%200%201.91374%200%201.22676C0%200.539773%200.539773%200%201.22676%200Z%22%20fill%3D%22rgba(255,255,255,0.05)%22%2F%3E%3C%2Fsvg%3E')] opacity-60"></div>
    <div class="relative flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-white/10 backdrop-blur-sm flex items-center justify-center border border-white/20">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-bold text-white">Inbox</h1>
          <p class="text-xs text-primary-200/80">
            <%= Current.user.synced_emails.count %> emails synced
          </p>
        </div>
      </div>
      <% if Current.user.google_connected? %>
        <%= button_to trigger_sync_settings_path,
            method: :post,
            class: "p-2.5 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-xl border border-white/20 transition-all duration-200",
            title: "Sync emails",
            data: { disable_with: "..." } do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="flex-1 flex overflow-hidden">
    <!-- Left Panel: Email List -->
    <div class="w-full lg:w-2/5 xl:w-1/3 flex flex-col border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"
         data-inbox-mobile-target="list">
      <!-- Desktop Header -->
      <div class="hidden lg:block relative overflow-hidden bg-gradient-to-r from-gray-900 via-slate-800 to-gray-900 p-4">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg%20width%3D%2230%22%20height%3D%2230%22%20viewBox%3D%220%200%2030%2030%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M1.22676%200C1.91374%200%202.45351%200.539773%202.45351%201.22676C2.45351%201.91374%201.91374%202.45351%201.22676%202.45351C0.539773%202.45351%200%201.91374%200%201.22676C0%200.539773%200.539773%200%201.22676%200Z%22%20fill%3D%22rgba(255,255,255,0.05)%22%2F%3E%3C%2Fsvg%3E')] opacity-60"></div>
        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-primary-500/20 to-transparent rounded-full blur-2xl"></div>
        <div class="relative flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-xl bg-white/10 backdrop-blur-sm flex items-center justify-center border border-white/20">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            </div>
            <div>
              <h1 class="text-lg font-bold text-white">Inbox</h1>
              <p class="text-xs text-primary-200/80">
                Interview-related emails
              </p>
            </div>
          </div>
          <% if Current.user.google_connected? %>
            <%= button_to trigger_sync_settings_path,
                method: :post,
                class: "group p-2.5 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-xl border border-white/20 transition-all duration-200",
                title: "Sync emails",
                data: { disable_with: "..." } do %>
              <svg class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Relevance Tabs -->
      <div class="flex border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
        <% relevance_tabs = [
          { key: "relevant", label: "Relevant", count: @relevance_counts[:relevant], icon: "M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" },
          { key: "interviews", label: "Interviews", count: @relevance_counts[:interviews], icon: "M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" },
          { key: "opportunities", label: "Opportunities", count: @relevance_counts[:opportunities], icon: "M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" },
          { key: "all", label: "All", count: @relevance_counts[:all], icon: "M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" }
        ] %>
        <% relevance_tabs.each do |tab| %>
          <%= link_to inbox_index_path(relevance: tab[:key], q: params[:q], status: params[:status]),
              class: "group flex-1 flex items-center justify-center gap-1.5 px-3 py-3 text-xs font-medium text-center border-b-2 transition-all duration-200 #{@current_relevance == tab[:key] ? 'border-primary-500 text-primary-600 dark:text-primary-400 bg-primary-50/50 dark:bg-primary-900/10' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50'}",
              data: { turbo_frame: "_top" } do %>
            <svg class="w-4 h-4 <%= @current_relevance == tab[:key] ? 'text-primary-500' : 'text-gray-400 group-hover:text-gray-500' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="<%= tab[:icon] %>"/>
            </svg>
            <span class="hidden sm:inline"><%= tab[:label] %></span>
            <% if tab[:count] > 0 %>
              <span class="px-1.5 py-0.5 text-[10px] font-semibold rounded-full <%= @current_relevance == tab[:key] ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' %>">
                <%= tab[:count] %>
              </span>
            <% end %>
          <% end %>
        <% end %>
      </div>

      <!-- Search & Filters -->
      <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50">
        <%= form_with url: inbox_index_path, method: :get, class: "space-y-3", data: { controller: "auto-submit", turbo_frame: "email_list", auto_submit_delay_value: "400", auto_submit_min_length_value: "3" } do |f| %>
          <%= f.hidden_field :relevance, value: @current_relevance %>
          <%= f.hidden_field :status, value: params[:status] %>
          
          <%# Search input - auto-searches after 3+ characters %>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <%= f.text_field :q,
                value: params[:q],
                id: "inbox-search",
                class: "w-full pl-10 pr-10 py-2.5 text-sm rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 shadow-sm",
                placeholder: "Search emails...",
                autocomplete: "off",
                data: { auto_submit_target: "input", action: "input->auto-submit#submit" } %>
            <% if params[:q].present? %>
              <button type="button"
                      data-controller="click-actions"
                      data-action="click->click-actions#clearAndSubmit"
                      data-click-actions-input-id-value="inbox-search"
                      class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            <% end %>
          </div>

          <%# Filter chips %>
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Filter:</span>
            <% status_options = [
              { value: "", label: "All emails", active: params[:status].blank? },
              { value: "unmatched", label: "Needs review", active: params[:status] == "unmatched" },
              { value: "matched", label: "Matched", active: params[:status] == "matched" }
            ] %>
            <% status_options.each do |opt| %>
              <%= link_to inbox_index_path(relevance: @current_relevance, q: params[:q], status: opt[:value].presence),
                  class: "inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-200 #{opt[:active] ? 'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 ring-1 ring-primary-300 dark:ring-primary-700' : 'bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-200 dark:border-gray-600'}",
                  data: { turbo_frame: "_top" } do %>
                <%= opt[:label] %>
              <% end %>
            <% end %>
            
            <% if params[:q].present? || params[:status].present? || (@current_relevance.present? && @current_relevance != "relevant") %>
              <%= link_to inbox_index_path,
                  class: "inline-flex items-center gap-1 px-2 py-1 text-xs text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors",
                  data: { turbo_frame: "_top" } do %>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Clear all
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Email List (scrollable) -->
      <%= turbo_frame_tag "email_list", class: "flex-1 overflow-y-auto" do %>
        <%= render "inbox/email_list", 
            grouped_emails: @grouped_emails, 
            unmatched_emails: @unmatched_emails,
            pagy_unmatched: @pagy_unmatched,
            selected_email_id: @selected_email&.id %>
      <% end %>

      <!-- Stats Footer -->
      <%= turbo_frame_tag "email_stats", class: "hidden lg:flex items-center justify-between px-4 py-2.5 border-t border-gray-200 dark:border-gray-700 bg-gray-50/80 dark:bg-gray-800/80 backdrop-blur-sm" do %>
        <div class="flex items-center gap-4">
          <span class="inline-flex items-center gap-1.5 text-xs">
            <span class="w-2 h-2 rounded-full bg-amber-400 animate-pulse"></span>
            <span class="font-medium text-amber-700 dark:text-amber-400"><%= @unmatched_emails.count %></span>
            <span class="text-gray-500 dark:text-gray-400">needs review</span>
          </span>
          <span class="inline-flex items-center gap-1.5 text-xs">
            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
            <span class="font-medium text-emerald-700 dark:text-emerald-400"><%= Current.user.synced_emails.matched.count %></span>
            <span class="text-gray-500 dark:text-gray-400">matched</span>
          </span>
        </div>
        <span class="text-[10px] text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">
          Last sync: <%= Current.user.synced_emails.maximum(:created_at)&.strftime("%b %d, %I:%M%P") || "Never" %>
        </span>
      <% end %>
    </div>

    <!-- Right Panel: Email Detail -->
    <div class="hidden lg:flex flex-1 flex-col bg-gray-50 dark:bg-gray-900"
         data-inbox-mobile-target="detail">
      <%= turbo_frame_tag "email_detail", class: "flex-1 flex flex-col overflow-hidden" do %>
        <%= render "inbox/empty_state" %>
      <% end %>
    </div>

    <!-- Mobile: Full-screen modal for email detail -->
    <div class="lg:hidden fixed inset-0 z-50 bg-white dark:bg-gray-800 transform translate-x-full transition-transform duration-300 ease-in-out"
         data-inbox-mobile-target="modal"
         data-action="keydown.esc->inbox-mobile#close">
      <div class="h-full flex flex-col">
        <!-- Mobile modal header -->
        <div class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-gray-900 via-slate-800 to-gray-900 border-b border-gray-700">
          <button type="button" 
                  class="p-2 -ml-1 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-xl transition-all duration-200"
                  data-action="click->inbox-mobile#close">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <span class="text-sm font-semibold text-white">Back to Inbox</span>
        </div>
        <!-- Mobile modal content -->
        <div class="flex-1 overflow-y-auto">
          <%= turbo_frame_tag "email_detail_mobile", class: "h-full" do %>
            <%= render "inbox/empty_state" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
