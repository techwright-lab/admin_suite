<% content_for :title, "#{@job_listing.display_title} - Admin" %>

<div class="px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
      <%= link_to admin_job_listings_path, class: "text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      <% end %>
      <h1 class="text-2xl font-bold text-slate-900 dark:text-white truncate"><%= @job_listing.display_title %></h1>
      <% status_colors = { "active" => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400", "closed" => "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300", "draft" => "bg-amber-100 text-amber-800 dark:bg-amber-900/20 dark:text-amber-400" } %>
      <span class="px-3 py-1 text-sm font-semibold rounded-full <%= status_colors[@job_listing.status] || status_colors['active'] %>">
        <%= @job_listing.status.titleize %>
      </span>
    </div>
    <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400">
      <span><%= @job_listing.company.name %></span>
      <span>•</span>
      <span><%= @job_listing.location || "No location" %></span>
      <span>•</span>
      <span><%= @job_listing.remote_type_display %></span>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="flex items-center gap-3 mb-6">
    <%= link_to edit_admin_job_listing_path(@job_listing), class: "inline-flex items-center px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors" do %>
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      Edit Listing
    <% end %>
    <% if @job_listing.url.present? %>
      <%= link_to @job_listing.url, target: "_blank", class: "inline-flex items-center px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 text-sm font-medium rounded-lg transition-colors" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
        View Original
      <% end %>
    <% end %>
  </div>

  <!-- Extraction Status -->
  <%= render "job_listings/extraction_status", job_listing: @job_listing %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Description -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Description</h2>
        <% if @job_listing.description.present? %>
          <div class="prose dark:prose-invert max-w-none">
            <%= format_job_text(@job_listing.description) %>
          </div>
        <% else %>
          <p class="text-sm text-slate-500 dark:text-slate-400 italic">No description extracted</p>
        <% end %>
      </div>

      <!-- Requirements -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Requirements</h2>
        <% if @job_listing.requirements.present? %>
          <div class="prose dark:prose-invert max-w-none">
            <%= format_list_text(@job_listing.requirements) %>
          </div>
        <% else %>
          <p class="text-sm text-slate-500 dark:text-slate-400 italic">No requirements extracted</p>
        <% end %>
      </div>

      <!-- Responsibilities -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Responsibilities</h2>
        <% if @job_listing.responsibilities.present? %>
          <div class="prose dark:prose-invert max-w-none">
            <%= format_list_text(@job_listing.responsibilities) %>
          </div>
        <% else %>
          <p class="text-sm text-slate-500 dark:text-slate-400 italic">No responsibilities extracted</p>
        <% end %>
      </div>

      <!-- Benefits & Perks -->
      <% if @job_listing.benefits.present? || @job_listing.perks.present? %>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Benefits & Perks</h2>
          
          <% if @job_listing.benefits.present? %>
            <div class="mb-4">
              <h3 class="text-sm font-medium text-slate-900 dark:text-white mb-2">Benefits</h3>
              <div class="prose dark:prose-invert max-w-none">
                <%= format_key_value_text(@job_listing.benefits) %>
              </div>
            </div>
          <% end %>
          
          <% if @job_listing.perks.present? %>
            <div>
              <h3 class="text-sm font-medium text-slate-900 dark:text-white mb-2">Perks</h3>
              <div class="prose dark:prose-invert max-w-none">
                <%= format_list_text(@job_listing.perks) %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Custom Sections - Group related items together -->
      <% if @job_listing.has_custom_sections? %>
        <%# Separate key-value sections from text sections %>
        <% 
          kv_sections = {}
          text_sections = {}
          
          @job_listing.custom_sections.each do |key, value|
            next if value.blank?
            
            # Check if it's a simple value (no newlines, short)
            if value.to_s.strip.length < 100 && !value.to_s.include?("\n")
              kv_sections[key] = value
            else
              text_sections[key] = value
            end
          end
        %>
        
        <%# Display key-value sections as a grouped info card %>
        <% if kv_sections.any? %>
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Additional Details</h2>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
              <% kv_sections.each do |key, value| %>
                <div class="flex flex-col">
                  <dt class="text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                    <%= key.to_s.titleize %>
                  </dt>
                  <dd class="mt-0.5 text-sm text-slate-900 dark:text-white">
                    <%= value %>
                  </dd>
                </div>
              <% end %>
            </dl>
          </div>
        <% end %>
        
        <%# Display text sections as regular sections %>
        <% text_sections.each do |key, value| %>
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
              <%= key.to_s.titleize %>
            </h2>
            <div class="prose dark:prose-invert max-w-none">
              <%= format_job_text(value) %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Quick Info -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4">
        <h3 class="text-sm font-semibold text-slate-900 dark:text-white mb-4">Details</h3>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-slate-500 dark:text-slate-400">Company</dt>
            <dd class="text-slate-900 dark:text-white font-medium"><%= @job_listing.company.name %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-500 dark:text-slate-400">Role</dt>
            <dd class="text-slate-900 dark:text-white font-medium"><%= @job_listing.job_role.title %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-500 dark:text-slate-400">Location</dt>
            <dd class="text-slate-900 dark:text-white"><%= @job_listing.location || "—" %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-slate-500 dark:text-slate-400">Remote Type</dt>
            <dd class="text-slate-900 dark:text-white"><%= @job_listing.remote_type_display %></dd>
          </div>
          <% if @job_listing.salary_range.present? %>
            <div class="flex justify-between">
              <dt class="text-slate-500 dark:text-slate-400">Salary</dt>
              <dd class="text-slate-900 dark:text-white"><%= @job_listing.salary_range %></dd>
            </div>
          <% end %>
          <% if @job_listing.equity_info.present? %>
            <div class="flex justify-between">
              <dt class="text-slate-500 dark:text-slate-400">Equity</dt>
              <dd class="text-slate-900 dark:text-white"><%= @job_listing.equity_info %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <!-- HTML Scraping Results -->
      <% if @html_scraping_log.present? %>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-slate-900 dark:text-white">HTML Scraping</h3>
            <span class="px-2 py-0.5 text-xs font-semibold rounded-full <%= @html_scraping_log.status_badge_color %>">
              <%= @html_scraping_log.status.titleize %>
            </span>
          </div>
          <dl class="space-y-2 text-sm">
            <div class="flex justify-between">
              <dt class="text-slate-500 dark:text-slate-400">Extraction Rate</dt>
              <dd class="font-medium <%= (@html_scraping_log.extraction_rate || 0) >= 0.7 ? 'text-green-600 dark:text-green-400' : (@html_scraping_log.extraction_rate || 0) >= 0.4 ? 'text-amber-600 dark:text-amber-400' : 'text-red-600 dark:text-red-400' %>">
                <%= @html_scraping_log.extraction_rate_display %>
              </dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-slate-500 dark:text-slate-400">Fields</dt>
              <dd class="text-slate-900 dark:text-white"><%= @html_scraping_log.fields_extracted %>/<%= @html_scraping_log.fields_attempted %></dd>
            </div>
          </dl>
          <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
            <%= link_to "View Details", admin_html_scraping_log_path(@html_scraping_log), class: "text-xs text-amber-600 dark:text-amber-400 hover:underline" %>
          </div>
        </div>
      <% end %>

      <!-- Scraping Attempts -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-slate-900 dark:text-white">Scraping Attempts</h3>
          <span class="text-xs text-slate-500 dark:text-slate-400"><%= @scraping_attempts.count %> recent</span>
        </div>
        <% if @scraping_attempts.any? %>
          <ul class="space-y-2">
            <% @scraping_attempts.each do |attempt| %>
              <li class="flex items-center justify-between py-1">
                <div class="flex items-center gap-2">
                  <% attempt_colors = { "completed" => "bg-green-500", "failed" => "bg-red-500", "pending" => "bg-slate-400" } %>
                  <span class="w-2 h-2 rounded-full <%= attempt_colors[attempt.status] || 'bg-slate-400' %>"></span>
                  <span class="text-xs text-slate-600 dark:text-slate-400"><%= attempt.created_at.strftime("%b %d, %H:%M") %></span>
                </div>
                <%= link_to "View", admin_scraping_attempt_path(attempt), class: "text-xs text-amber-600 dark:text-amber-400 hover:underline" %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="text-sm text-slate-500 dark:text-slate-400">No scraping attempts</p>
        <% end %>
      </div>

      <!-- AI Extraction Logs -->
      <% if @ai_extraction_logs.any? %>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-slate-900 dark:text-white">AI Extractions</h3>
          </div>
          <ul class="space-y-2">
            <% @ai_extraction_logs.each do |log| %>
              <li class="flex items-center justify-between py-1">
                <div class="flex items-center gap-2">
                  <% ai_colors = { "success" => "bg-green-500", "error" => "bg-red-500", "timeout" => "bg-amber-500" } %>
                  <span class="w-2 h-2 rounded-full <%= ai_colors[log.status] || 'bg-slate-400' %>"></span>
                  <span class="text-xs text-slate-600 dark:text-slate-400">
                    <%= log.provider.titleize %> • <%= log.formatted_latency %>
                  </span>
                </div>
                <%= link_to "View", admin_ai_extraction_log_path(log), class: "text-xs text-amber-600 dark:text-amber-400 hover:underline" %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  </div>
</div>

