<% content_for :title, "#{@synced_email.subject} - Admin" %>

<div class="px-4 sm:px-6 lg:px-8">
  <%= render "admin/shared/page_header",
      title: @synced_email.subject,
      description: "From: #{@synced_email.from_name.presence || @synced_email.from_email}",
      breadcrumbs: [
        { label: "Synced Emails", path: admin_synced_emails_path },
        { label: @synced_email.subject.truncate(30) }
      ],
      actions: render("admin/shared/action_bar", actions: [
        {
          label: "Edit",
          path: edit_admin_synced_email_path(@synced_email),
          style: :primary
        }
      ]) %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Email Details -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
          Email Details
        </h2>
        <dl class="space-y-4">
          <div>
            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">From</dt>
            <dd class="mt-1 text-sm text-slate-900 dark:text-white">
              <%= @synced_email.from_name.present? ? "#{@synced_email.from_name} <#{@synced_email.from_email}>" : @synced_email.from_email %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Subject</dt>
            <dd class="mt-1 text-sm text-slate-900 dark:text-white">
              <%= @synced_email.subject %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Date</dt>
            <dd class="mt-1 text-sm text-slate-900 dark:text-white">
              <%= @synced_email.email_date&.strftime("%B %d, %Y at %H:%M") || "—" %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Status</dt>
            <dd class="mt-1">
              <%= render "admin/shared/status_badge", status: @synced_email.status, custom_colors: {
                "pending" => "bg-amber-100 text-amber-800 dark:bg-amber-900/20 dark:text-amber-400",
                "processed" => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",
                "ignored" => "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400",
                "failed" => "bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400"
              } %>
            </dd>
          </div>
          <% if @synced_email.email_type.present? %>
            <div>
              <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">Email Type</dt>
              <dd class="mt-1 text-sm text-slate-900 dark:text-white">
                <%= @synced_email.email_type.titleize %>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>

      <!-- Email Content -->
      <% if @synced_email.body_preview.present? || @synced_email.snippet.present? %>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
            Email Content
          </h2>
          <% if @synced_email.body_preview.present? %>
            <div class="prose dark:prose-invert max-w-none mb-4">
              <%= simple_format(@synced_email.body_preview) %>
            </div>
          <% elsif @synced_email.snippet.present? %>
            <p class="text-sm text-slate-600 dark:text-slate-400">
              <%= @synced_email.snippet %>
            </p>
          <% end %>
        </div>
      <% end %>

      <!-- Matched Application -->
      <% if @synced_email.interview_application.present? %>
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
            Matched Application
          </h2>
          <div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-700/50">
            <p class="text-sm font-medium text-slate-900 dark:text-white">
              <%= @synced_email.interview_application.company.name %> • <%= @synced_email.interview_application.job_role.title %>
            </p>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
              <%= @synced_email.interview_application.user.display_name %>
            </p>
            <%= link_to "View Application", admin_interview_application_path(@synced_email.interview_application), class: "mt-3 inline-block text-sm text-amber-600 dark:text-amber-400 hover:underline" %>
          </div>
        </div>
      <% else %>
        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-6">
          <div class="flex items-start">
            <svg class="w-5 h-5 text-amber-600 dark:text-amber-400 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-1">
              <h3 class="text-sm font-medium text-amber-800 dark:text-amber-300">Not Matched</h3>
              <p class="mt-2 text-sm text-amber-700 dark:text-amber-400">
                This email has not been matched to an interview application. <%= link_to "Edit", edit_admin_synced_email_path(@synced_email), class: "font-medium underline" %> to manually match it.
              </p>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <%= render "admin/shared/info_card",
          title: "Email Details",
          data: {
            "User" => (@synced_email.user.present? ? link_to(@synced_email.user.display_name, admin_user_path(@synced_email.user), class: "text-amber-600 dark:text-amber-400 hover:underline") : "—"),
            "Email Sender" => (@synced_email.email_sender.present? ? @synced_email.email_sender.email : "—"),
            "Gmail ID" => @synced_email.gmail_id.truncate(20)
          } %>

      <%= render "admin/shared/info_card",
          title: "Timestamps",
          data: {
            "Email Date" => @synced_email.email_date&.strftime("%B %d, %Y at %H:%M") || "—",
            "Created" => @synced_email.created_at.strftime("%B %d, %Y at %H:%M"),
            "Updated" => @synced_email.updated_at.strftime("%B %d, %Y at %H:%M")
          } %>
    </div>
  </div>
</div>

