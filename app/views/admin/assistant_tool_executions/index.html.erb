<% content_for :title, "Assistant Tool Executions - Admin" %>

<div class="px-4 sm:px-6 lg:px-8" data-controller="bulk-select">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Tool Executions</h1>
    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">
      Inspect proposed/queued/running/success/error executions and approve gated tools.
    </p>
  </div>

  <!-- Stats Grid -->
  <%= render "admin/shared/stats_grid",
    stats: @stats,
    colors: {
      total: "text-slate-900 dark:text-white",
      proposed: "text-slate-700 dark:text-slate-300",
      queued: "text-blue-600 dark:text-blue-400",
      running: "text-amber-600 dark:text-amber-400",
      success: "text-green-600 dark:text-green-400",
      error: "text-red-600 dark:text-red-400",
      confirmation_required: "text-purple-600 dark:text-purple-400"
    },
    grid_class: "grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4 mb-6" %>

  <div class="flex flex-col lg:flex-row gap-6">
    <!-- Filters Sidebar -->
    <%= render "admin/shared/filter_sidebar",
      url: admin_assistant_tool_executions_path,
      filters: [
        { type: :select, name: :status, label: "Status", options: [["All Statuses", ""]] + Assistant::ToolExecution::STATUSES.map { |v| [v.titleize, v] }, value: params[:status] },
        { type: :select, name: :requires_confirmation, label: "Confirmation", options: [["All", ""], ["Required", "true"], ["Not Required", "false"]], value: params[:requires_confirmation] },
        { type: :text, name: :tool_key, label: "Tool Key", placeholder: "confirm_user_memory", value: params[:tool_key] },
        { type: :text, name: :trace_id, label: "Trace ID", placeholder: "uuid...", value: params[:trace_id] },
        { type: :number, name: :thread_id, label: "Thread ID", placeholder: "123", value: params[:thread_id] }
      ] %>

    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <!-- Bulk Actions Bar -->
      <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 mb-4 hidden" data-bulk-select-target="actionBar">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-sm text-slate-700 dark:text-slate-300">
              <span data-bulk-select-target="count">0</span> selected
            </span>
            <button type="button" data-action="bulk-select#clearAll" class="text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 underline">
              Clear
            </button>
          </div>
          <div class="flex items-center gap-2">
            <%= form_with url: bulk_approve_admin_assistant_tool_executions_path, method: :post, local: true, data: { "bulk-select-target": "approveForm" } do %>
              <input type="hidden" name="execution_ids" value="" data-bulk-select-target="approveIds">
              <% @filters.each do |key, value| %>
                <input type="hidden" name="<%= key %>" value="<%= value %>">
              <% end %>
              <button type="submit" class="px-3 py-1.5 text-sm font-medium bg-amber-500 hover:bg-amber-600 text-white rounded-lg transition-colors">
                Approve Selected
              </button>
            <% end %>
            <%= form_with url: bulk_enqueue_admin_assistant_tool_executions_path, method: :post, local: true, data: { "bulk-select-target": "enqueueForm" } do %>
              <input type="hidden" name="execution_ids" value="" data-bulk-select-target="enqueueIds">
              <% @filters.each do |key, value| %>
                <input type="hidden" name="<%= key %>" value="<%= value %>">
              <% end %>
              <button type="submit" class="px-3 py-1.5 text-sm font-medium bg-slate-900 hover:bg-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 text-white rounded-lg transition-colors">
                Enqueue Selected
              </button>
            <% end %>
          </div>
        </div>
      </div>

      <div id="tool-executions-list" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
            <thead class="bg-slate-50 dark:bg-slate-900">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider w-10">
                  <input type="checkbox" data-action="bulk-select#toggleAll" data-bulk-select-target="selectAll" class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-slate-300 rounded dark:border-slate-600 dark:bg-slate-700">
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Time</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Tool</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Confirmation</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Trace</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
              <% @tool_executions.each do |te| %>
                <tr id="<%= dom_id(te) %>" class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                  <td class="px-4 py-3 whitespace-nowrap">
                    <% if te.status == "proposed" %>
                      <input type="checkbox" value="<%= te.id %>" data-action="bulk-select#toggle" data-bulk-select-target="checkbox" class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-slate-300 rounded dark:border-slate-600 dark:bg-slate-700">
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                    <div><%= te.created_at.strftime("%b %d, %H:%M") %></div>
                    <div class="text-xs text-slate-400 dark:text-slate-500"><%= time_ago_in_words(te.created_at) %> ago</div>
                  </td>
                  <td class="px-4 py-3">
                    <div class="text-sm font-medium text-slate-900 dark:text-white font-mono"><%= te.tool_key %></div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">Thread #<%= te.thread_id %></div>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap">
                    <% status_colors = {
                      "proposed" => "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-300",
                      "queued" => "bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400",
                      "running" => "bg-amber-100 text-amber-800 dark:bg-amber-900/20 dark:text-amber-400",
                      "success" => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",
                      "error" => "bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400",
                      "cancelled" => "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
                    } %>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <%= status_colors[te.status] || 'bg-slate-100 text-slate-800' %>">
                      <%= te.status&.titleize %>
                    </span>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">
                    <% if te.requires_confirmation? %>
                      <% if te.approved_by_id.present? %>
                        <span class="text-green-600 dark:text-green-400">Approved</span>
                      <% else %>
                        <span class="text-amber-600 dark:text-amber-400">Pending</span>
                      <% end %>
                    <% else %>
                      <span class="text-slate-400">Not required</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3">
                    <div class="text-xs font-mono text-slate-500 dark:text-slate-400 max-w-[120px] truncate" title="<%= te.trace_id %>">
                      <%= te.trace_id %>
                    </div>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <div class="flex items-center gap-2">
                      <%= link_to "View", admin_assistant_tool_execution_path(te), class: "text-amber-600 hover:text-amber-800 dark:text-amber-400 font-medium" %>
                      <% if te.status == "proposed" %>
                        <% if te.requires_confirmation? && te.approved_by_id.nil? %>
                          <%= button_to "Approve", approve_admin_assistant_tool_execution_path(te), method: :post, class: "px-2 py-1 text-xs font-medium bg-amber-500 hover:bg-amber-600 text-white rounded transition-colors" %>
                        <% else %>
                          <%= button_to "Enqueue", enqueue_admin_assistant_tool_execution_path(te), method: :post, class: "px-2 py-1 text-xs font-medium bg-slate-900 hover:bg-slate-800 text-white rounded transition-colors" %>
                        <% end %>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
              <% if @tool_executions.empty? %>
                <tr>
                  <td colspan="7" class="px-4 py-8 text-center text-sm text-slate-500 dark:text-slate-400">
                    No tool executions found
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <%= render "admin/shared/pagination", pagy: @pagy %>
      </div>
    </div>
  </div>
</div>
