<% content_for :title, "Email Senders - Admin" %>

<div class="px-4 sm:px-6 lg:px-8">
  <%= render "admin/shared/page_header",
      title: "Email Senders",
      description: "Manage email senders discovered from Gmail sync and associate them with companies" %>

  <%= render "admin/shared/stats_grid",
      stats: @stats,
      colors: {
        total: "text-slate-900 dark:text-white",
        unassigned: "text-amber-600 dark:text-amber-400",
        assigned: "text-green-600 dark:text-green-400",
        auto_detected: "text-blue-600 dark:text-blue-400",
        verified: "text-emerald-600 dark:text-emerald-400",
        ats_systems: "text-purple-600 dark:text-purple-400",
        unique_domains: "text-slate-900 dark:text-white"
      },
      columns: 7 %>

  <div class="flex flex-col lg:flex-row gap-6">
    <div class="lg:w-64 flex-shrink-0 space-y-4">
      <%= render "admin/shared/filter_sidebar",
          url: admin_email_senders_path,
          filters: [
            {
              type: :text,
              name: :search,
              label: "Search",
              placeholder: "Email, name, domain...",
              value: @filters[:search]
            },
            {
              type: :select,
              name: :status,
              label: "Status",
              options: [
                ["All", ""],
                ["Unassigned", "unassigned"],
                ["Assigned", "assigned"],
                ["Auto-detected", "auto_detected"],
                ["Verified", "verified"]
              ],
              value: @filters[:status]
            },
            {
              type: :select,
              name: :sender_type,
              label: "Sender Type",
              options: [["All", ""]] + EmailSender::SENDER_TYPES.map { |type| [type.titleize, type] },
              value: @filters[:sender_type]
            },
            {
              type: :select,
              name: :domain,
              label: "Domain",
              options: [["All domains", ""]] + @domains.first(50).map { |domain| [domain, domain] },
              value: @filters[:domain]
            },
            {
              type: :select,
              name: :sort,
              label: "Sort By",
              options: [
                ["Recent", ""],
                ["Most Active", "email_count"],
                ["Last Seen", "last_seen"],
                ["Alphabetical", "alphabetical"]
              ],
              value: @filters[:sort]
            }
          ],
          width: "lg:w-64" %>

      <!-- Bulk Assign Card -->
      <% if @filters[:domain].present? %>
        <div
          class="
            bg-white dark:bg-slate-800 rounded-xl shadow-sm border
            border-amber-200 dark:border-amber-700 p-4
          "
        >
          <h3 class="text-sm font-semibold text-slate-900 dark:text-white mb-2">
            Bulk Assign Domain
          </h3>

          <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
            Assign all senders from
            <strong class="text-slate-700 dark:text-slate-300"><%= @filters[:domain] %></strong>
            to a company
          </p>

          <%= form_with url: bulk_assign_admin_email_senders_path, method: :post, local: true, class: "space-y-3" do %>
            <input type="hidden" name="domain" value="<%= @filters[:domain] %>">

            <div>
              <select
                name="company_id"
                required
                class="
                  w-full rounded-lg border-slate-300 dark:border-slate-600
                  dark:bg-slate-700 dark:text-white text-sm
                "
              >
                <option value="">Select company...</option>

                <% @companies.each do |company| %>
                  <option value="<%= company.id %>"><%= company.name %></option>
                <% end %>
              </select>
            </div>

            <button
              type="submit"
              class="
                w-full px-3 py-2 bg-amber-500 hover:bg-amber-600 text-white
                text-sm font-medium rounded-lg transition-colors
              "
              data-turbo-confirm="Are you sure you want to assign all senders from <%= @filters[:domain] %> to this company?"
            >
              Assign All from Domain
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="flex-1 min-w-0">
      <%= render "admin/shared/data_table",
          collection: @email_senders,
          columns: [
            {
              header: "Sender",
              content: ->(sender) do
                content_tag(:div, class: "max-w-xs") do
                  content_tag(:p, class: "text-sm font-medium text-slate-900 dark:text-white truncate") do
                    sender.email.html_safe +
                    (sender.verified? ? content_tag(:span, "", class: "ml-1 inline-flex items-center", title: "Verified") do
                      tag.svg(class: "w-4 h-4 text-emerald-500", fill: "currentColor", viewBox: "0 0 20 20") do
                        tag.path(fill_rule: "evenodd", d: "M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z", clip_rule: "evenodd")
                      end
                    end : "".html_safe)
                  end +
                  (sender.name.present? ? content_tag(:p, sender.name, class: "text-xs text-slate-500 dark:text-slate-400 truncate") : "".html_safe)
                end
              end
            },
            {
              header: "Domain",
              content: ->(sender) do
                link_to sender.domain, admin_email_senders_path(domain: sender.domain), 
                    class: "text-sm text-amber-600 hover:text-amber-800 dark:text-amber-400 font-medium"
              end,
              class: "whitespace-nowrap"
            },
            {
              header: "Company",
              content: ->(sender) do
                if sender.company.present?
                  render "admin/shared/status_badge", status: sender.company.name, custom_colors: { sender.company.name => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400" }
                elsif sender.auto_detected_company.present?
                  content_tag(:span, "#{sender.auto_detected_company.name} (auto)", class: "px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400", title: "Auto-detected")
                else
                  render "admin/shared/status_badge", status: "unassigned", custom_colors: { "unassigned" => "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400" }
                end
              end,
              class: "whitespace-nowrap"
            },
            {
              header: "Type",
              content: ->(sender) do
                type_colors = {
                  "recruiter" => "bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400",
                  "hiring_manager" => "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/20 dark:text-indigo-400",
                  "hr" => "bg-pink-100 text-pink-800 dark:bg-pink-900/20 dark:text-pink-400",
                  "ats_system" => "bg-amber-100 text-amber-800 dark:bg-amber-900/20 dark:text-amber-400",
                  "unknown" => "bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
                }
                render "admin/shared/status_badge", status: sender.sender_type || "unknown", custom_colors: type_colors
              end,
              class: "whitespace-nowrap"
            },
            {
              header: "Emails",
              content: ->(sender) do
                content_tag(:div) do
                  content_tag(:span, sender.email_count, class: "text-sm text-slate-600 dark:text-slate-400") +
                  (sender.last_seen_at.present? ? content_tag(:span, "#{time_ago_in_words(sender.last_seen_at)} ago", class: "text-xs text-slate-400 dark:text-slate-500 block") : "".html_safe)
                end
              end,
              class: "whitespace-nowrap text-sm text-slate-600 dark:text-slate-400"
            },
            {
              header: "Actions",
              content: ->(sender) do
                content_tag(:div, class: "flex items-center gap-2") do
                  link_to("View", admin_email_sender_path(sender), class: "text-amber-600 hover:text-amber-800 dark:text-amber-400 font-medium") +
                  link_to("Edit", edit_admin_email_sender_path(sender), class: "text-slate-600 hover:text-slate-800 dark:text-slate-400 font-medium")
                end
              end,
              class: "whitespace-nowrap text-sm"
            }
          ],
          empty_message: "No email senders found" %>

      <%= render "admin/shared/pagination", pagy: @pagy %>
    </div>
  </div>
</div>
