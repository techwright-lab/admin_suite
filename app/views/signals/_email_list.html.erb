<%# locals: (grouped_emails:, unmatched_emails:, selected_email_id: nil, pagy_unmatched: nil, show_unified_list: false, all_emails: [], pagy_all: nil) %>

<div class="divide-y divide-gray-100 dark:divide-gray-700/50">
  <% if show_unified_list %>
    <!-- Unified Chronological List (All tab) -->
    <% if all_emails.any? %>
      <div class="divide-y divide-gray-100 dark:divide-gray-700/50">
        <% all_emails.each do |email| %>
          <%= render "signals/email_row", email: email, selected: selected_email_id == email.id, show_company: true %>
        <% end %>
      </div>
      
      <% if pagy_all && pagy_all.pages > 1 %>
        <div class="px-4 py-3 bg-gray-50/80 dark:bg-gray-800/80 border-t border-gray-200/60 dark:border-gray-700/40">
          <div class="flex items-center justify-between text-xs">
            <span class="text-gray-600 dark:text-gray-400">
              Page <%= pagy_all.page %> of <%= pagy_all.pages %>
            </span>
            <div class="flex gap-2">
              <% preserved_params = { relevance: params[:relevance], q: params[:q], status: params[:status], type: params[:type], company_id: params[:company_id] }.compact %>
              <% if pagy_all.prev %>
                <%= link_to "← Previous", signals_path(preserved_params.merge(page: pagy_all.prev)),
                  class: "px-3 py-1.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium transition-colors",
                  data: { turbo_frame: "_top" } %>
              <% end %>
              <% if pagy_all.next %>
                <%= link_to "Next →", signals_path(preserved_params.merge(page: pagy_all.next)),
                  class: "px-3 py-1.5 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium transition-colors",
                  data: { turbo_frame: "_top" } %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <!-- Empty state for unified list -->
      <div class="p-12 text-center">
        <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
        <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1">No emails found</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400">Try adjusting your filters or search query</p>
      </div>
    <% end %>
  <% else %>
  <!-- Signals Needing Attention -->
  <% if unmatched_emails.any? %>
    <div class="bg-gradient-to-b from-amber-50 to-amber-50/50 dark:from-amber-900/20 dark:to-amber-900/10">
      <div class="sticky top-0 z-10 px-4 py-3 bg-amber-100/90 dark:bg-amber-900/40 backdrop-blur-sm border-b border-amber-200/60 dark:border-amber-800/40">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-7 h-7 rounded-lg bg-amber-200 dark:bg-amber-800/60 flex items-center justify-center">
              <svg class="w-4 h-4 text-amber-700 dark:text-amber-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <div>
              <span class="text-sm font-semibold text-amber-900 dark:text-amber-200">
                Signals worth your attention
              </span>
              <span class="ml-2 px-2 py-0.5 text-xs font-bold bg-amber-200 dark:bg-amber-800 text-amber-800 dark:text-amber-200 rounded-full">
                <%= pagy_unmatched ? pagy_unmatched.count : unmatched_emails.count %>
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="divide-y divide-amber-100 dark:divide-amber-800/30">
        <% unmatched_emails.each do |email| %>
          <%= render "signals/email_row", email: email, selected: selected_email_id == email.id, show_company: true %>
        <% end %>
      </div>
      
      <% if pagy_unmatched && pagy_unmatched.pages > 1 %>
        <div class="px-4 py-3 bg-amber-50/80 dark:bg-amber-900/20 border-t border-amber-200/60 dark:border-amber-800/40">
          <div class="flex items-center justify-between text-xs">
            <span class="text-amber-700 dark:text-amber-400">
              Page <%= pagy_unmatched.page %> of <%= pagy_unmatched.pages %>
            </span>
            <div class="flex gap-2">
              <% preserved_params = { relevance: params[:relevance], q: params[:q], status: params[:status], type: params[:type], company_id: params[:company_id] }.compact %>
              <% if pagy_unmatched.prev %>
                <%= link_to "← Previous", signals_path(preserved_params.merge(unmatched_page: pagy_unmatched.prev)),
                  class: "px-3 py-1.5 text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40 rounded-lg font-medium transition-colors",
                  data: { turbo_frame: "_top" } %>
              <% end %>
              <% if pagy_unmatched.next %>
                <%= link_to "Next →", signals_path(preserved_params.merge(unmatched_page: pagy_unmatched.next)),
                  class: "px-3 py-1.5 text-amber-700 dark:text-amber-300 hover:bg-amber-100 dark:hover:bg-amber-900/40 rounded-lg font-medium transition-colors",
                  data: { turbo_frame: "_top" } %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Matched Emails by Application -->
  <% if grouped_emails.any? %>
    <% grouped_emails.each do |application, emails| %>
      <% next unless application %>
      <% expanded_by_default = selected_email_id.present? ? emails.any? { |e| e.id == selected_email_id } : true %>
      <div class="email-group" data-controller="expandable" data-expandable-expanded-value="<%= expanded_by_default %>">
        <!-- Application Header -->
        <div class="sticky top-0 z-10 px-4 py-3 bg-gray-50/95 dark:bg-gray-800/95 backdrop-blur-sm border-b border-gray-200/80 dark:border-gray-700/80">
          <div class="flex items-center gap-3">
            <div class="relative">
              <div class="w-10 h-10 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 rounded-xl flex items-center justify-center text-sm font-bold text-gray-600 dark:text-gray-300 shadow-sm">
                <%= application.company.name[0].upcase %>
              </div>
              <% if emails.count > 1 %>
                <span class="absolute -bottom-1 -right-1 w-5 h-5 bg-primary-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center shadow-sm">
                  <%= emails.count %>
                </span>
              <% end %>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                  <%= application.company.name %>
                </span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] font-semibold uppercase tracking-wide
                  <%= case application.pipeline_stage.to_sym
                      when :applied then 'bg-gray-100 text-gray-600 dark:bg-gray-600 dark:text-gray-300'
                      when :screening then 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400'
                      when :interviewing then 'bg-violet-100 text-violet-700 dark:bg-violet-900/40 dark:text-violet-400'
                      when :offer then 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-400'
                      else 'bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300'
                      end %>">
                  <%= application.pipeline_stage_display %>
                </span>
              </div>
              <span class="text-xs text-gray-500 dark:text-gray-400">
                <%= application.job_role.title %>
              </span>
            </div>

            <%# Collapse/expand signals list for this application %>
            <button type="button"
                    class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                    title="Collapse/expand signals"
                    aria-label="Collapse/expand signals"
                    data-action="click->expandable#toggle">
              <svg class="w-4 h-4 transition-transform duration-200" data-expandable-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>
            <%= link_to interview_application_path(application),
                class: "p-1.5 text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",
                title: "View application" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
            <% end %>
          </div>
        </div>

        <div data-expandable-target="content">
          <%# Signals in this application (progressively loaded in batches of 5) %>
          <%
            base_limit = 5
            selected_index = selected_email_id.present? ? emails.index { |e| e.id == selected_email_id } : nil
            initial_limit =
              if selected_index && selected_index >= base_limit
                # Round up so the selected email is visible in a "batch of 5" world.
                ((selected_index / base_limit) + 1) * base_limit
              else
                base_limit
              end
            initial_limit = [initial_limit, 50].min
            frame_id = "signals_application_#{application.id}_emails"
          %>

          <%= turbo_frame_tag frame_id do %>
            <%= render "signals/application_emails",
              application: application,
              emails: emails,
              limit: initial_limit,
              frame_id: frame_id,
              selected_email_id: selected_email_id %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- Empty State -->
  <% if grouped_emails.empty? && unmatched_emails.empty? %>
    <div class="p-12 text-center">
      <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center mb-4">
        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
      </div>
      <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1">No signals found</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
        Try adjusting your filters or search query
      </p>
      <% unless Current.user.google_connected? %>
        <%= link_to settings_path(tab: "integrations"),
            class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-xl shadow-lg shadow-primary-500/25 transition-all duration-200" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
          </svg>
          Connect Gmail
        <% end %>
      <% end %>
    </div>
  <% end %>
  <% end %> <%# Close the else block for show_unified_list %>
</div>
