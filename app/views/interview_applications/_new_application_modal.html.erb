<div
  id="new-application-modal"
  data-controller="modal application-modal"
  class="hidden fixed inset-0 z-50 overflow-y-auto"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div
    class="
      fixed inset-0 bg-black/30 dark:bg-black/50 transition-opacity
      backdrop-blur-sm
    "
    data-action="click->modal#hide"
  ></div>

  <!-- Modal Content -->
  <div class="flex min-h-full items-center justify-center p-4">
    <div
      data-modal-target="content"
      class="
        relative transform overflow-hidden rounded-xl bg-white
        dark:bg-gray-800 shadow-xl transition-all w-full max-w-2xl
      "
    >
      <!-- Header -->
      <div
        class="
          bg-white dark:bg-gray-800 px-6 py-4
        "
      >
        <div class="flex items-center justify-between">
          <h3
            class="text-lg font-semibold text-gray-900 dark:text-white"
            id="modal-title"
          >
            New Application
          </h3>
          <button
            type="button"
            data-action="click->modal#hide"
            class="
              text-gray-400 hover:text-gray-500 dark:hover:text-gray-300
              focus:outline-none
            "
          >
            <span class="sr-only">Close</span>
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Tabs -->
        <div class="mt-4 border-b border-gray-200 dark:border-gray-700">
          <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button
              type="button"
              data-application-modal-target="quickApplyTab"
              data-action="click->application-modal#switchToQuickApply"
              class="
                border-b-2 border-primary-500 text-primary-600 dark:text-primary-400
                whitespace-nowrap py-2 px-1 text-sm font-medium
              "
            >
              Quick Apply
            </button>
            <button
              type="button"
              data-application-modal-target="manualEntryTab"
              data-action="click->application-modal#switchToManualEntry"
              class="
                border-b-2 border-transparent text-gray-500 hover:text-gray-700
                hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300
                whitespace-nowrap py-2 px-1 text-sm font-medium
              "
            >
              Manual Entry
            </button>
          </nav>
        </div>
      </div>

      <!-- Form Content -->
      <div
        class="
          bg-white dark:bg-gray-800 px-6 py-6 max-h-[calc(100vh-200px)]
          overflow-y-auto
        "
      >
        <!-- Quick Apply Tab -->
        <div
          data-application-modal-target="quickApplyPanel"
          class="space-y-5"
        >
          <!-- Quick Apply Form Content (hidden during loading) -->
          <div data-application-modal-target="quickApplyFormContent">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Paste a job listing URL and we'll automatically extract the company and job details.
              </p>
            </div>

            <!-- Quick Apply Form -->
            <form
              data-application-modal-target="quickApplyForm"
              data-action="submit->application-modal#handleQuickApply"
              class="space-y-5"
            >
              <div>
                <label
                  for="quick-apply-url"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                >
                  Job Listing URL
                  <span class="text-red-500">*</span>
                </label>
                <input
                  type="url"
                  id="quick-apply-url"
                  name="url"
                  required
                  placeholder="https://boards.greenhouse.io/company/jobs/123"
                  class="
                    w-full px-3 py-2 border border-gray-300 dark:border-gray-600
                    rounded-lg shadow-sm focus:outline-none focus:ring-2
                    focus:ring-primary-500 focus:border-primary-500
                    bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                  "
                  data-application-modal-target="urlInput"
                />
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                  Supports Greenhouse, Lever, LinkedIn, Indeed, and other job boards
                </p>
              </div>

              <!-- Error Message -->
              <div
                data-application-modal-target="errorMessage"
                class="hidden p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg"
              >
                <p class="text-sm text-red-800 dark:text-red-200"></p>
              </div>

              <!-- Form Actions -->
              <div
                class="
                  flex items-center justify-end gap-3 pt-4 border-t
                  border-gray-200 dark:border-gray-700
                "
              >
                <button
                  type="button"
                  data-action="click->modal#hide"
                  class="
                    px-5 py-2.5 text-sm font-medium text-gray-700
                    dark:text-gray-300 bg-white dark:bg-gray-800 border
                    border-gray-300 dark:border-gray-600 rounded-lg
                    hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none
                    focus:ring-2 focus:ring-offset-2 focus:ring-primary-500
                    transition-colors
                  "
                >
                  Cancel
                </button>

                <button
                  type="submit"
                  data-application-modal-target="quickApplyButton"
                  class="
                    px-5 py-2.5 text-sm font-medium text-white bg-primary-600
                    hover:bg-primary-700 rounded-lg focus:outline-none focus:ring-2
                    focus:ring-offset-2 focus:ring-primary-500 shadow-sm hover:shadow
                    transition-all disabled:opacity-50 disabled:cursor-not-allowed
                  "
                >
                  Quick Apply
                </button>
              </div>
            </form>
          </div>

          <!-- Full-Panel Loading State (shown during extraction) -->
          <div
            data-application-modal-target="loadingIndicator"
            class="hidden"
          >
            <div class="flex flex-col items-center justify-center py-12 px-6">
              <!-- Animated loader -->
              <div class="relative mb-6">
                <div class="w-16 h-16 border-4 border-primary-200 dark:border-primary-800 rounded-full"></div>
                <div class="absolute top-0 left-0 w-16 h-16 border-4 border-primary-600 dark:border-primary-400 rounded-full border-t-transparent animate-spin"></div>
              </div>
              
              <!-- Loading text with animation -->
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                Extracting Job Details
              </h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 text-center max-w-sm mb-6">
                We're fetching the job listing page and extracting all the important details. This usually takes 5-15 seconds.
              </p>
              
              <!-- Progress steps -->
              <div class="w-full max-w-xs space-y-3">
                <div class="flex items-center gap-3 text-sm" data-application-modal-target="loadingStep1">
                  <div class="flex-shrink-0 w-5 h-5 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center">
                    <svg class="w-3 h-3 text-primary-600 dark:text-primary-400 animate-pulse" fill="currentColor" viewBox="0 0 8 8">
                      <circle cx="4" cy="4" r="3" />
                    </svg>
                  </div>
                  <span class="text-gray-600 dark:text-gray-400">Fetching job listing page...</span>
                </div>
                <div class="flex items-center gap-3 text-sm opacity-50" data-application-modal-target="loadingStep2">
                  <div class="flex-shrink-0 w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                    <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                  </div>
                  <span class="text-gray-500 dark:text-gray-500">Analyzing content...</span>
                </div>
                <div class="flex items-center gap-3 text-sm opacity-50" data-application-modal-target="loadingStep3">
                  <div class="flex-shrink-0 w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                    <div class="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                  </div>
                  <span class="text-gray-500 dark:text-gray-500">Creating application...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Success Message (shown after completion) -->
          <div
            data-application-modal-target="successMessage"
            class="hidden"
          >
            <div class="flex flex-col items-center justify-center py-12 px-6">
              <div class="w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                Application Created!
              </h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 text-center"></p>
            </div>
          </div>
        </div>

        <!-- Manual Entry Tab -->
        <div
          data-application-modal-target="manualEntryPanel"
          class="hidden space-y-5"
      >
        <%= form_with(
              model: InterviewApplication.new,
              url: interview_applications_path,
              local: true,
              class: "space-y-5",
              data: { action: "submit->application-modal#handleManualSubmit" }
            ) do |form| %>
          <!-- Company Autocomplete -->
          <div>
            <%= render "shared/autocomplete",
              form: form,
              field_name: :company_id,
              label: "Company",
              placeholder: "Search or create company...",
              autocomplete_url: autocomplete_companies_path,
              create_url: companies_path,
              modal_id: "company-modal",
              value: nil,
              display_value: nil,
              required: true,
              help_text: "Start typing to search, or create a new company if not found" %>
          </div>

          <!-- Job Role Autocomplete -->
          <div>
            <%= render "shared/autocomplete",
              form: form,
              field_name: :job_role_id,
              label: "Job Role",
              placeholder: "Search or create job role...",
              autocomplete_url: autocomplete_job_roles_path,
              create_url: job_roles_path,
              modal_id: "job-role-modal",
              value: nil,
              display_value: nil,
              required: true,
              help_text: "The position you're applying for" %>
          </div>

          <!-- Job Listing URL (Optional) -->
          <div>
            <%= form.label :job_listing_url, "Job Listing URL (Optional)", class: "form-label" %>
            <%= form.url_field :job_listing_url,
                placeholder: "https://example.com/jobs/123",
                class: "form-input" %>
            <p class="form-help-text">
              We'll automatically fetch job details from this URL
            </p>
          </div>

          <!-- Applied Date (Optional) -->
          <div>
            <%= form.label :applied_at, "Applied Date (Optional)", class: "form-label" %>
            <%= form.date_field :applied_at,
                value: Date.today,
                class: "form-input" %>
            <p class="form-help-text">
              Defaults to today if not specified
            </p>
          </div>

          <!-- Notes (Optional) -->
          <div>
            <%= form.label :notes, "Notes (Optional)", class: "form-label" %>
            <%= form.text_area :notes,
                rows: 3,
                placeholder: "Add any notes about this application...",
                class: "form-textarea" %>
          </div>

          <!-- Manual Entry Loading State -->
          <div
            data-application-modal-target="manualLoadingIndicator"
            class="hidden"
          >
            <div class="flex items-center gap-3 p-4 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg">
              <svg
                class="animate-spin h-5 w-5 text-primary-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <div>
                <p class="text-sm font-medium text-primary-800 dark:text-primary-200">
                  Creating application...
                </p>
                <p class="text-xs text-primary-600 dark:text-primary-400">
                  We're fetching job details from the URL. This may take a moment.
                </p>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div
            data-application-modal-target="manualFormActions"
            class="
              flex items-center justify-end gap-3 pt-4 border-t
              border-gray-200 dark:border-gray-700
            "
          >
            <button
              type="button"
              data-action="click->modal#hide"
              class="
                px-5 py-2.5 text-sm font-medium text-gray-700
                dark:text-gray-300 bg-white dark:bg-gray-800 border
                border-gray-300 dark:border-gray-600 rounded-lg
                hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none
                focus:ring-2 focus:ring-offset-2 focus:ring-primary-500
                transition-colors
              "
            >
              Cancel
            </button>

            <%= form.submit "Create Application",
                data: { 
                  disable_with: "Creating...",
                  application_modal_target: "manualSubmitButton"
                },
                class: "px-5 py-2.5 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 shadow-sm hover:shadow transition-all disabled:opacity-50 disabled:cursor-not-allowed" %>
          </div>
        <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
