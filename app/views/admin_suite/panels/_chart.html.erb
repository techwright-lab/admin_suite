<% data = Array(panel_eval(panel.options[:data])) %>
<% total = panel.options[:total] %>
<% color = (panel.options[:color] || theme_primary).to_sym %>
<% max_value = (data.map { |d| d[:value].to_f }.max || 1).to_f %>
<% max_value = 1.0 if max_value.zero? %>

<% bar_color = case color
  when :amber then "bg-amber-500"
  when :green then "bg-green-500"
  when :red then "bg-red-500"
  when :cyan then "bg-cyan-500"
  when :violet then "bg-violet-500"
  when :indigo then "bg-indigo-500"
  else "bg-indigo-500"
end %>

<div class="bg-white rounded-xl border border-slate-200 p-4">
  <div class="flex items-center justify-between mb-4">
    <h3 class="font-semibold text-slate-900"><%= panel.title %></h3>
    <% if total.present? %>
      <span class="text-2xl font-bold text-slate-900"><%= total %></span>
    <% end %>
  </div>

  <% if data.any? %>
    <div class="flex items-end gap-1 h-16">
      <% data.each do |d| %>
        <% value = d[:value].to_f %>
        <% height_float = (value / max_value) * 100.0 %>
        <% height_float = 0.0 if height_float.nan? || height_float.infinite? %>
        <% height = height_float.round %>
        <div class="flex-1 flex flex-col items-center gap-1">
          <div class="w-full rounded-t <%= bar_color %> transition-all" style="height: <%= height %>%"
               title="<%= "#{d[:label]}: #{d[:value]}" %>"></div>
        </div>
      <% end %>
    </div>

    <div class="flex gap-1 mt-2">
      <% data.each do |d| %>
        <div class="flex-1 text-center text-xs text-slate-400"><%= d[:label].to_s.first(3) %></div>
      <% end %>
    </div>
  <% else %>
    <div class="p-4 text-sm text-slate-500">No chart data.</div>
  <% end %>
</div>
